default_platform(:ios)

platform :ios do
  desc "Upload metadata to App Store Connect"
  lane :metadata do
    deliver(
      skip_binary_upload: true,
      skip_screenshots: false,
      force: true,
      automatic_release: false,
      submit_for_review: false,
      precheck_include_in_app_purchases: false,
      app_version: "1.0.0",
      primary_category: "UTILITIES",
      secondary_category: "PRODUCTIVITY"
    )
  end

  desc "Build release archive"
  lane :build do
    gym(
      scheme: "ToneType",
      configuration: "Release",
      export_method: "app-store",
      output_directory: "./build",
      output_name: "ToneType.ipa",
      clean: true
    )
  end

  desc "Upload build to App Store Connect"
  lane :upload do
    pilot(
      ipa: "./build/ToneType.ipa",
      skip_waiting_for_build_processing: true,
      skip_submission: true
    )
  end

  desc "Set age rating to 4+ (all content ratings NONE)"
  lane :set_age_rating do
    require 'spaceship'
    Spaceship::ConnectAPI.login(CredentialsManager::AppfileConfig.try_fetch_value(:apple_id))

    app = Spaceship::ConnectAPI::App.find(CredentialsManager::AppfileConfig.try_fetch_value(:app_identifier))
    UI.message("App: #{app.name}")

    app_info = app.fetch_live_app_info || app.fetch_edit_app_info
    UI.message("AppInfo ID: #{app_info.id}")

    ard = app_info.fetch_age_rating_declaration
    ard.update(attributes: {
      'alcoholTobaccoOrDrugUseOrReferences' => 'NONE',
      'contests' => 'NONE',
      'gamblingSimulated' => 'NONE',
      'medicalOrTreatmentInformation' => 'NONE',
      'profanityOrCrudeHumor' => 'NONE',
      'sexualContentGraphicAndNudity' => 'NONE',
      'sexualContentOrNudity' => 'NONE',
      'horrorOrFearThemes' => 'NONE',
      'matureOrSuggestiveThemes' => 'NONE',
      'unrestrictedWebAccess' => false,
      'violenceCartoonOrFantasy' => 'NONE',
      'violenceRealisticProlongedGraphicOrSadistic' => 'NONE',
      'violenceRealistic' => 'NONE',
      'gambling' => false,
      'ageAssurance' => false,
      'lootBox' => false,
      'gunsOrOtherWeapons' => 'NONE',
      'advertising' => false,
      'healthOrWellnessTopics' => false,
      'userGeneratedContent' => false,
      'messagingAndChat' => false,
      'parentalControls' => false
    })
    UI.success("Age rating set to 4+")
  end

  desc "Set pricing to Free and upload copyright"
  lane :prepare_submission do
    require 'spaceship'
    Spaceship::ConnectAPI.login(CredentialsManager::AppfileConfig.try_fetch_value(:apple_id))
    app = Spaceship::ConnectAPI::App.find(CredentialsManager::AppfileConfig.try_fetch_value(:app_identifier))

    # Set pricing to Free via appPriceSchedules
    client = Spaceship::ConnectAPI.client
    body = {
      data: {
        type: "appPriceSchedules",
        relationships: {
          app: { data: { type: "apps", id: app.id } },
          baseTerritory: { data: { type: "territories", id: "USA" } },
          manualPrices: { data: [
            {
              type: "appPrices",
              id: "${price1}",
              attributes: { startDate: nil },
              relationships: {
                appPricePoint: {
                  data: { type: "appPricePoints", id: "eyJzIjoiNjc1OTAwOTMwMCIsInQiOiJVU0EiLCJwIjoiMTAwMDAifQ" }
                }
              }
            }
          ] }
        }
      }
    }

    begin
      resp = client.post("appPriceSchedules", body)
      UI.success("Pricing set to Free")
    rescue => e
      UI.important("Pricing API error (may need manual setup): #{e.message}")
    end

    # Upload copyright via version metadata
    version = app.get_edit_app_store_version
    version.update(attributes: { copyright: "2026 ToneType" })
    UI.success("Copyright set to '2026 ToneType'")
  end

  desc "Full pipeline: build, upload, metadata"
  lane :release do
    build
    upload
    metadata
  end
end

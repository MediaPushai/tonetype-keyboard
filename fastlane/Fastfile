default_platform(:ios)

platform :ios do
  desc "Upload metadata to App Store Connect"
  lane :metadata do
    deliver(
      skip_binary_upload: true,
      skip_screenshots: false,
      force: true,
      automatic_release: false,
      submit_for_review: false,
      precheck_include_in_app_purchases: false,
      app_version: "1.0.0",
      primary_category: "UTILITIES",
      secondary_category: "PRODUCTIVITY"
    )
  end

  desc "Build release archive"
  lane :build do
    gym(
      scheme: "ToneType",
      configuration: "Release",
      export_method: "app-store",
      output_directory: "./build",
      output_name: "ToneType.ipa",
      clean: true
    )
  end

  desc "Upload build to App Store Connect"
  lane :upload do
    pilot(
      ipa: "./build/ToneType.ipa",
      skip_waiting_for_build_processing: true,
      skip_submission: true
    )
  end

  desc "Set age rating to 4+ (all content ratings NONE)"
  lane :set_age_rating do
    require 'spaceship'
    Spaceship::ConnectAPI.login(CredentialsManager::AppfileConfig.try_fetch_value(:apple_id))

    app = Spaceship::ConnectAPI::App.find(CredentialsManager::AppfileConfig.try_fetch_value(:app_identifier))
    UI.message("App: #{app.name}")

    app_info = app.fetch_live_app_info || app.fetch_edit_app_info
    UI.message("AppInfo ID: #{app_info.id}")

    ard = app_info.fetch_age_rating_declaration
    ard.update(attributes: {
      'alcoholTobaccoOrDrugUseOrReferences' => 'NONE',
      'contests' => 'NONE',
      'gamblingSimulated' => 'NONE',
      'medicalOrTreatmentInformation' => 'NONE',
      'profanityOrCrudeHumor' => 'NONE',
      'sexualContentGraphicAndNudity' => 'NONE',
      'sexualContentOrNudity' => 'NONE',
      'horrorOrFearThemes' => 'NONE',
      'matureOrSuggestiveThemes' => 'NONE',
      'unrestrictedWebAccess' => false,
      'violenceCartoonOrFantasy' => 'NONE',
      'violenceRealisticProlongedGraphicOrSadistic' => 'NONE',
      'violenceRealistic' => 'NONE',
      'gambling' => false,
      'ageAssurance' => false,
      'lootBox' => false,
      'gunsOrOtherWeapons' => 'NONE',
      'advertising' => false,
      'healthOrWellnessTopics' => false,
      'userGeneratedContent' => false,
      'messagingAndChat' => false,
      'parentalControls' => false
    })
    UI.success("Age rating set to 4+")
  end

  desc "Set pricing to Free and upload copyright"
  lane :prepare_submission do
    require 'spaceship'
    Spaceship::ConnectAPI.login(CredentialsManager::AppfileConfig.try_fetch_value(:apple_id))
    app = Spaceship::ConnectAPI::App.find(CredentialsManager::AppfileConfig.try_fetch_value(:app_identifier))

    # Set pricing to Free via appPriceSchedules
    client = Spaceship::ConnectAPI.client
    body = {
      data: {
        type: "appPriceSchedules",
        relationships: {
          app: { data: { type: "apps", id: app.id } },
          baseTerritory: { data: { type: "territories", id: "USA" } },
          manualPrices: { data: [
            {
              type: "appPrices",
              id: "${price1}",
              attributes: { startDate: nil },
              relationships: {
                appPricePoint: {
                  data: { type: "appPricePoints", id: "eyJzIjoiNjc1OTAwOTMwMCIsInQiOiJVU0EiLCJwIjoiMTAwMDAifQ" }
                }
              }
            }
          ] }
        }
      }
    }

    begin
      resp = client.post("appPriceSchedules", body)
      UI.success("Pricing set to Free")
    rescue => e
      UI.important("Pricing API error (may need manual setup): #{e.message}")
    end

    # Upload copyright via version metadata
    version = app.get_edit_app_store_version
    version.update(attributes: { copyright: "2026 ToneType" })
    UI.success("Copyright set to '2026 ToneType'")
  end

  desc "Switch build on app store version to Build 2 (iPhone-only)"
  lane :swap_build do
    require 'spaceship'
    Spaceship::ConnectAPI.login(CredentialsManager::AppfileConfig.try_fetch_value(:apple_id))

    app = Spaceship::ConnectAPI::App.find(CredentialsManager::AppfileConfig.try_fetch_value(:app_identifier))
    UI.message("App: #{app.name}")

    version = app.get_edit_app_store_version
    UI.message("Edit version: #{version.version_string} (ID: #{version.id})")

    # Get all builds
    builds = app.get_builds
    builds.each do |b|
      UI.message("Build: #{b.version} (#{b.id}) - processing: #{b.processing_state}")
    end

    # Find build number 2 (iPhone-only)
    target_build = builds.find { |b| b.version == "2" }
    if target_build.nil?
      UI.user_error!("Could not find build number 2")
    end

    UI.message("Selecting build: #{target_build.version} (#{target_build.id})")

    # Update the version to use the new build
    version.select_build(build_id: target_build.id)
    UI.success("Build swapped to build number #{target_build.version}!")
  end

  desc "Cancel App Store review submission"
  lane :cancel_review do
    require 'spaceship'
    Spaceship::ConnectAPI.login(CredentialsManager::AppfileConfig.try_fetch_value(:apple_id))

    app = Spaceship::ConnectAPI::App.find(CredentialsManager::AppfileConfig.try_fetch_value(:app_identifier))
    UI.message("App: #{app.name}")

    # Check for version in review
    version = app.get_edit_app_store_version || app.get_pending_release_app_store_version
    if version.nil?
      UI.user_error!("No editable or pending version found")
    end

    UI.message("Version: #{version.version_string}, State: #{version.app_store_state}")

    # Cancel by removing the submission via the version's submission relationship
    submission = version.fetch_app_store_version_submission
    if submission
      UI.message("Found submission: #{submission.id}, cancelling...")
      submission.delete!
      UI.success("Review submission CANCELLED!")
    else
      UI.important("No active submission found (state: #{version.app_store_state})")
    end
  end

  desc "Check App Store and TestFlight review status"
  lane :check_status do
    require 'spaceship'

    Spaceship::Tunes.login(CredentialsManager::AppfileConfig.try_fetch_value(:apple_id))

    app = Spaceship::ConnectAPI::App.find(CredentialsManager::AppfileConfig.try_fetch_value(:app_identifier))
    UI.message("=" * 50)
    UI.message("App: #{app.name} (#{app.bundle_id})")
    UI.message("=" * 50)

    # App Store version status
    UI.header("App Store Review Status")
    versions = app.get_app_store_versions
    if versions && versions.any?
      versions.each do |v|
        UI.message("  v#{v.version_string}: #{v.app_store_state}")
      end
    else
      UI.important("  No App Store versions found")
    end

    # Builds and TestFlight status
    UI.message("")
    UI.header("Builds / TestFlight Status")
    builds = app.get_builds
    if builds && builds.any?
      builds.each do |b|
        UI.message("  Build #{b.version} â€” Processing: #{b.processing_state}")
        begin
          beta = b.get_build_beta_details
          if beta
            UI.message("    External: #{beta.external_build_state}")
            UI.message("    Internal: #{beta.internal_build_state}")
          end
        rescue => e
          UI.message("    Beta details: #{e.message}")
        end
      end
    else
      UI.important("  No builds found")
    end

    UI.message("=" * 50)
  end

  desc "Full pipeline: build, upload, metadata"
  lane :release do
    build
    upload
    metadata
  end
end
